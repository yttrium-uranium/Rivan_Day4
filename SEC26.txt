

Your Monitor Number = #$34t#







Check Supported Ciphers/Cipher Suite

Directory:
C:\ProgramData\Microsoft\Crypto\Keys


!@NetOps
openssl ciphers -v

DNS:
ns   A
ca   A
cert CNAME
__   A
www  A
ftp  CNAME

*******************

SETUP
!@NetOps
mkdir /certs;cd /certs

 

In order to create an SSL Cert, Certificates MUST be configured.

STEP 1. Create a self-signed cert on linux using openssl. (Sakit ulo windows certreq)

> GENERATE PRIVATE KEY

SERVER
For root CA (NetOps) 
!@NetOps
openssl genrsa -aes256 -out netops-ca.key 2048

SUBCA
For root SUBCA (NetOps) 
!@NetOps
openssl genrsa -aes256 -out netops-subca.key 2048

or

CLIENT
For (Windows)
!@Powershell
$ca = New-SelfSignedCertificate `
  -Subject "CN=RivanCyber Institute CEBU, O=Rivancorp, OU=ICT, L=Cebu, ST=Central Visayas, C=PH" `
  -DnsName "ns.rivancorp.com" `
  -KeyAlgorithm RSA `
  -KeyLength 2048 `
  -HashAlgorithm SHA256 `
  -KeyUsage CertSign, CRLSign, DigitalSignature `
  -KeyUsageProperty Sign `
  -CertStoreLocation "Cert:\LocalMachine\My" `
  -TextExtension @(
    "2.5.29.19={text}ca=true&pathlength=1"
  ) `
  -NotAfter (Get-Date).AddYears(10)


Then, Create and Export the CA

!@NetOps
cd /certs
ftp [IP Address]
ftp> binary
ftp> get win.pfx


> Create an OPENSSL configuration file to support Subject Alt Names

SERVER
!@NetOps
nano ca.cnf

~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_ca
prompt             = no
default_md         = sha256

[ req_distinguished_name ]
C  = PH
ST = NCR
L  = Manila
O  = Rivancorp
OU = Admin
CN = Rivancorp Root CA

[ v3_ca ]
basicConstraints = critical, CA:true
keyUsage = critical, keyCertSign, cRLSign
subjectKeyIdentifier = hash

[v3_subca]
basicConstraints = critical, CA:true
keyUsage = critical, keyCertSign, cRLSign
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer
~~~



SERVER
!@NetOps
nano subca.cnf

~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_subca
prompt             = no
default_md         = sha256

[ req_distinguished_name ]
C  = PH
ST = NCR
L  = Manila
O  = Rivancorp
OU = IT Department
CN = Rivancorp SubCA

[ v3_subca ]
basicConstraints = critical, CA:true, pathlen:0
keyUsage = critical, keyCertSign, cRLSign
~~~




CLIENT
!@NetOps
nano win.cnf

~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_leaf
prompt             = no

[ req_distinguished_name ]
C  = PH
ST = Central Visayas
L  = Cebu
O  = Rivancorp
OU = ICT
CN = www.rivancorp.com

[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1   = www.rivancorp.com
DNS.2   = rivancorp.com
IP.1    = 192.168.102.100
~~~



> OUTPUT SELF-SIGNED CA

SERVER
!@NetOps
openssl req \
-new -x509 \
-key netops-ca.key \
-out netops-ca.crt \
-days 365 \
-extensions v3_ca \
-config ca.cnf


> CREATE A CSR FOR THE SUBCA USING THE SELFSIGNED CA

SERVER SUBCA
!@NetOps
openssl req -new \
-key netops-subca.key \
-out netops-subca.csr \
-config subca.cnf \
-extensions v3_subca


> SIGN THE SUBCA CSR USING THE SELFSIGNED CA

!@NetOps
openssl x509 -req \
-in netops-subca.csr \
-CA netops-ca.crt \
-CAkey netops-ca.key \
-CAcreateserial \
-out netops-subca.crt \
-days 3650 \
-extfile ca.cnf \
-extensions v3_subca \
-copy_extensions copy



STEP 2. Generate then sign the CSR for the client

*IF PFX WAS GENERATED BY WINDOWS

> OUTPUT THE PRIVATE KEY
!@NetOps
openssl pkcs12 -in win.pfx -nocerts -out win.key -nodes


> EXPORT THE CERTIFICATE
!@NetOps
openssl pkcs12 -in win.pfx -nokeys -out win.crt

********


> GENERATE A CERTIFICATE SIGNING REQUEST

!@NetOps
openssl req -new \
-key win.key \
-out win.csr \
-config win.cnf \
-extensions v3_leaf


> SIGN THE CSR

Create another file:
!@NetOps
nano win-ext.cnf

~~~
[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = www.rivancorp.com
DNS.2 = rivancorp.com
IP.1  = 192.168.102.100
~~~


!@NetOps
openssl x509 -req \
  -in win.csr \
  -CA netops-subca.crt \
  -CAkey netops-subca.key \
  -CAcreateserial \
  -out grant-win.pem \
  -days 365 \
  -extfile win-ext.cnf \
  -extensions v3_leaf





STEP 3. Convert the granted certificate to PFX format

> CONVERT PEM TO PFX

!@NetOps
openssl pkcs12 -export \
-in grant-win.pem \
-inkey win.key \
-out grant-win.pfx




STEP 4. Transfer the CA & Granted Certificate to Windows.

> ENABLE FTP ON WINDOWS SERVER



> TRANSFER FILES VIA FTP - NOTE: Make sure PFX files are transferred in Binary NOT ASCII

!@NetOps
cd /certs
ftp [IP]

ftp> put netops-ca.crt
ftp> binary
ftp> put grant-win.pfx



STEP 5. Install the Granted Certificates on Windows IIS

Win + R : mmc


> ADD THE CA (netops.crt) to the Trusted Root Certification Authorities

> INSTALL THE GRANTED CERT (grant-win.pfx) in IIS Manager








*******************
TRANSPORT LAYER SECURITY

> Setup FTP with SSL Certificate

> CREATE ANOTHER SIGNED CERT FOR LINUX

CLIENT
!@NetOps
nano linux.cnf

~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_leaf
prompt             = no

[ req_distinguished_name ]
C  = PH
ST = Central Visayas
L  = Cebu
O  = Rivancorp
OU = FTP
CN = ftp.rivancorp.com

[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1   = ftp.rivancorp.com
DNS.2   = rivancorp.com
IP.1    = 192.168.102.10
~~~


> GENERATE A CERTIFICATE SIGNING REQUEST

!@NetOps
openssl req -new \
-key netops-ca.key \
-out linux.csr \
-config linux.cnf \
-extensions v3_leaf


> SIGN THE CSR

Create another file:
!@NetOps
nano linux-ext.cnf

~~~
[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = ftp.rivancorp.com
DNS.2 = rivancorp.com
IP.1  = 192.168.102.10
~~~


!@NetOps
openssl x509 -req \
  -in linux.csr \
  -CA netops-subca.crt \
  -CAkey netops-subca.key \
  -CAcreateserial \
  -out grant-linux.pem \
  -days 365 \
  -extfile linux-ext.cnf \
  -extensions v3_leaf



***************



1. Install lftp

!@NetOps
sudo yum install lftp

2. Access Windows FTP Server

!@NetOps
cd /certs
cat netops-ca.crt netops-subca.crt > fullchain.pem
lftp -u administrator [IP ADDRESS]
set ssl:ca-file fullchain.pem
set ftp:ssl-force true
set ftp:ssl-protect-data true





















*******************
S2S VPN Certificates


1. UTM-PH

~~~
!@VPN-PH
conf t
 hostname UTM-PH
 enable secret pass
 service password-encryption
 no logging cons
 no ip domain lookup
 line vty 0 14
  transport input all
  password pass
  login local
  exec-timeout 0 0
 int g1
  ip add 208.8.8.11 255.255.255.0
  no shut
 int g2
  ip add 192.168.102.11 255.255.255.0
  no shut
 int g3
  ip add 11.11.11.113 255.255.255.224
  no shut
 !
 username admin privilege 15 secret pass
 ip http server
 ip http secure-server
 ip http authentication local
 end
wr
~~~



2.  UTM-JP

~~~
@VPN-JP
conf t
 hostname UTM-JP
 enable secret pass
 service password-encryption
 no logging cons
 no ip domain lookup
 line vty 0 14
  transport input all
  password pass
  login local 
  exec-timeout 0 0
 int g1
  ip add 208.8.8.12 255.255.255.0
  no shut
 int g2
  ip add 192.168.102.12 255.255.255.0
  no shut
 int g3
  ip add 21.21.21.213 255.255.255.240
  ip add 22.22.22.223 255.255.255.192 secondary
  no shut
 !
 username admin privilege 15 secret pass
 ip http server
 ip http secure-server
 ip http authentication local
 end
wr
~~~


3. BDLG-PH

~~~
!@BLDG-PH
sudo su
ifconfig eth0 11.11.11.100 netmask 255.255.255.224 up
route add default gw 11.11.11.113
ping 11.11.11.113
~~~


4. BLDG-JP
~~~
@BLDG-JP
sudo su
ifconfig eth0 21.21.21.211 netmask 255.255.255.240 up
route add default gw 21.21.21.213
ping 21.21.21.213
~~~

5. Install the RootCA & SubCA on Cisco Routers

~~~
!@UTM-PH & UTM-JP
conf t
crypto pki trustpoint NETOPS-CA
 enrollment terminal
 revocation-check none
 hash sha256
 exit
crypto pki trustpoint NETOPS-SUBCA
 enrollment terminal
 revocation-check none
 hash sha256
 end
~~~


> INSTALL THE CA

~~~
conf t
 crypto pki authenticate NETOPS-CA
~~~


~~~
conf t
 crypto pki authenticate NETOPS-SUBCA
~~~



5. Create CSR for both UTM Routers

~~~
!@UTM-PH
conf t
 ip domain name utmph.com
 crypto key generate rsa label KEY modulus 2048
 end
~~~


~~~
!@UTM-JP
conf t
 ip domain name utmjp.com
 crypto key generate rsa label KEY modulus 2048
 end
~~~




5. Generate RSA Key Pair on both routers.

~~~
!@UTM-PH, UTM-JP
conf t
 crypto key generate rsa general-keys label rivankeys modulus 2048 exportable
 end
~~~


6.  Generate CSRs

~~~
!@UTM-PH & UTM-JP
conf t
 crypto pki enroll NETOPS-SUBCA
~~~




7. Transfer CSR

~~~
!@NetOps
cd /certs
nano utmph.csr

~~~


~~~
!@NetOps
cd /certs
nano utmjp.csr

~~~


~~~
!@UTM-PH
-----BEGIN CERTIFICATE REQUEST-----
...
-----END CERTIFICATE REQUEST-----
~~~



~~~
!@UTM-JP
-----BEGIN CERTIFICATE REQUEST-----
...
-----END CERTIFICATE REQUEST-----
~~~




~~~
CLIENT - UTM-PH
!@NetOps
nano utm-ph.cnf
~~~


~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_leaf
prompt             = no

[ req_distinguished_name ]
C  = PH
ST = NCR	
L  = Makati
O  = Rivancorp
OU = VPN-PH
CN = vpnph.rivancorp.com

[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1   = vpnph.rivancorp.com
DNS.2   = rivancorp.com
IP.1    = 208.8.8.11
~~~


~~~
!@NetOps
nano utm-jp.cnf
~~~


~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_leaf
prompt             = no

[ req_distinguished_name ]
C  = JP
ST = Tokyo	
L  = Minato
O  = Rivancorp
OU = VPN-JP
CN = vpnjp.rivancorp.com

[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1   = vpnjp.rivancorp.com
DNS.2   = rivancorp.com
IP.1    = 208.8.8.12
~~~




8. Sign the CSRs

Create another file:

~~~
!@NetOps
nano utmph-ext.cnf
~~~


~~~
[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1   = vpnph.rivancorp.com
DNS.2   = rivancorp.com
IP.1    = 208.8.8.11
~~~


~~~
!@NetOps
openssl x509 -req \
  -in utmph.csr \
  -CA netops-subca.crt \
  -CAkey netops-subca.key \
  -CAcreateserial \
  -out grant-utmph.pem \
  -days 365 \
  -extfile utmph-ext.cnf \
  -extensions v3_leaf
~~~



> Create another file:
~~~
!@NetOps
nano utmjp-ext.cnf
~~~


~~~
[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1   = vpnjp.rivancorp.com
DNS.2   = rivancorp.com
IP.1    = 208.8.8.12
~~~


~~~
!@NetOps
openssl x509 -req \
  -in utmjp.csr \
  -CA netops-subca.crt \
  -CAkey netops-subca.key \
  -CAcreateserial \
  -out grant-utmjp.pem \
  -days 365 \
  -extfile utmjp-ext.cnf \
  -extensions v3_leaf
~~~




9. Transfer the Signed Certificate then Import to the Router

~~~
!@NetOps
cat grant-utmph.pem 
~~~


~~~
!@UTM-PH
conf t
crypto pki import NETOPS-SUBCA certificate
~~~


~~~
!@NetOps
cat grant-utmjp.pem 
~~~


~~~
!@UTM-JP
conf t
crypto pki import NETOPS-SUBCA certificate
~~~












10. Configure VPN via Certificate Authentication


> GRE Tunnel
~~~
!@VPN-PH
conf t
 int tun1
  ip add 172.16.10.1 255.255.255.0
  tunnel source g1
  tunnel destination 208.8.8.12
  tunnel mode gre ip
  end
~~~



~~~
!@VPN-JP
conf t
 int tun1
  ip add 172.16.10.2 255.255.255.0
  tunnel source g1
  tunnel destination 208.8.8.11
  tunnel mode gre ip
  end
~~~




> 02. Routing Interesting traffic

~~~
!@VPN-PH
conf t
 ip route 21.21.21.208 255.255.255.240 172.16.10.2
 ip route 22.22.22.192 255.255.255.192 172.16.10.2
 end
~~~



~~~
!@VPN-JP
conf t
 ip route 11.11.11.96 255.255.255.224 172.16.10.1
 end
~~~




> 03. Configure ISAKMP Policy

~~~
!@VPN-PH, VPN-JP
conf t
 crypto isakmp policy 1
  authentication rsa-sig
  encryption aes 256
  hash sha512
  group 14
  end
~~~



> 04. Configure IPSec Profile

~~~
!@VPN-PH, VPN-JP
conf t
 crypto ipsec transform-set IPSECTUNNEL esp-aes 256 esp-sha-hmac
  mode transport
  exit
 crypto ipsec profile RIVAN
  set transform-set IPSECTUNNEL
  set pfs group14
  end
~~~


> 05. Apply IPSec Profile Protection to Tunnel
~~~
!@VPN-PH, VPN-JP
conf t
 int tunnel 1
  tunnel protection ipsec profile RIVAN 
  end
~~~



Verify:
~~~
!@VPN-PH, VPN-JP
show crypto isakmp sa
show crypto ipsec sa
~~~




*********************
Clear Configs

!@UTM-PH
conf t
 no ip route 21.21.21.208 255.255.255.240 172.16.10.2
 no ip route 22.22.22.192 255.255.255.192 172.16.10.2
 ip route 21.21.21.208 255.255.255.240 208.8.8.12
 ip route 22.22.22.192 255.255.255.192 208.8.8.12
 end


!@UTM-JP
conf t
 no ip route 11.11.11.96 255.255.255.224 172.16.10.1
 ip route 11.11.11.96 255.255.255.224 208.8.8.11
 end
 
 
 
 
 
 
 
 
## Packet Filtering (L3 ACL)
~~~
!@NetOps-PH
youporn.com      66.254.114.79
pornhub.com      66.254.114.41
redtube.com      66.254.114.238
faketaxi.com     66.254.114.234
bangbros.com
bangbus.com      172.67.133.243
pinayflix.com    104.21.55.88
xhamster.com
iyottube.com
~~~

<br>

Protect your most important asset: The brain
Create a standard ACL named FWP1
~~~
!@UTM-PH
config t
 no ip access-list standard FWP1
 ip access-list standard FWP1
  deny __.__.__.__  __.__.__.__
  deny __.__.__.__  __.__.__.__
  deny __.__.__.__  __.__.__.__
  permit any
 int gi 1
  ip access-group FWP1 in
  end
show ip access-list int g1
~~~

<br>

### Exercise: Block Torrents - Create a standard ACL named FWP2
~~~
!@UTM-PH
www.thepiratebay.org 
www.limetorrents.net
www.freeanimeonline.com
~~~

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

&nbsp;
---
&nbsp;

### L4 Firewall Rules
`www.rivanit.com` vs `neu.edu.ph` vs 'sti.edu.ph'

<br>




### Make Your UTM Router Vulnerable
~~~
!@UTM-PH
config t
 ip access-list extended NAT 
  25 deny ip 208.8.8.0 0.0.0.255 208.8.8.0 0.0.0.255
  exit
 service finger
 service tcp-small-servers
 service udp-small-servers
 ip dns server
 ip http server
 ip http secure-server
 telephony-service
  no auto-reg-ephone
  max-ephones 5
  max-dn 20
  ip source-address 208.8.8.11 port 2000
  exit
 voice service voip
  allow-connections h323 to sip
          
  allow-connections sip to h323
  allow-connections sip to sip
  supplementary-service h450.12
 sip
   bind control source-interface g1
   bind media source-interface g1
   registrar server expires max 600 min 60
 voice register global
  mode cme
  source-address 208.8.8.11 port 5060
  max-dn 12
  max-pool 12
  authenticate register
  create profile sync syncinfo.xml
  end
~~~

<br>

### Protect you Network
Create an extended ACL named FWP3
Open only the following ports:
  http, https, ping, ssh, dns

<br>

Formula:
|  PROTOCOL    |  HACKER  |  VICTIM  |  PORT         |
| ---          | ---      | ---      | ---           |
| TCP/UDP/ICMP |   ANY    |          |  Dest.Port eq |

~~~
!@UTM-PH
conf t
 no ip access-list extended FWP3
 ip access-list extended FWP3
 permit __ Any host www.____.com eq __ log
 permit __ Any host www.____.com eq __ log
 permit __ Any host www.____.com log
 permit __ Any host www.____.com eq __ log
 permit __ Any host www.____.com eq __ log
 permit __ Any host www.____.com eq __ log
 Int gi 3
  ip access-group FWP3 in
  end
~~~

<br>

### Exercise: Learn by doing the wrong things
Create an extended ACL named FWP4
Open only the following ports:
  telnet, sql, sip, sccp, ftp, imap, pop, smtp

<br>
<br>

---
&nbsp;

### Zone Based Firewall
Stateless vs Stateful  

<br>

Establish Zero Trust
~~~
!@UTM-JP

G1: OUTSIDE
G2: INSIDE
G3: DMZ
Tun1: VPN

Policy
INBOUND:  OUT-IN      DROP
OUTBOUND: IN-OUT      INSPECT
DOMAIN:   OUT-DMZ     INSPECT (RESTRICT)
~~~

<br>

1. Define Zones and Interfaces
~~~
!@UTM-JP
conf t
 zone security OUTSIDE
  description PUBLIC_INTERFACE
 zone security INSIDE
  description LOCAL_LAN
 zone security DMZ
  description SECURE_PUB_SERVERS
 !
 int g1
  zone-member security OUTSIDE
 int g2
  zone-member security INSIDE
 int g3
  zone-member security DMZ
  end
~~~

<br>

2. Create an ACL to match traffic rules
~~~
!@FW
conf t
 ip access-list extended INSIDE-TO-OUTSIDE
  10 permit ip any any
 ip access-list extended OUTSIDE-TO-INSIDE
  10 deny ip any any
  end
~~~

<br>

3. Group traffic using Class Maps
~~~
!@FW
conf t
 class-map type inspect match-any CM-IN-TO-OUT
  match access-group name INSIDE-TO-OUTSIDE
 class-map type inspect match-any CM-OUT-TO-IN
  match access-group name OUTSIDE-TO-INSIDE
  end
~~~

<br>

4. Define Policy Maps to Act on the traffic (ex. inspect, drop, pass, log)
~~~
!@FW
conf t
 policy-map type inspect INSIDE-OUTSIDE-POLICY
  class class-default
   drop log
 policy-map type inspect OUTSIDE-INSIDE-POLICY
  class class-default
   drop log
   end
~~~

<br>

5. Define Zone-Pairs to link source and destination zone to policies in a specific direction.
~~~
!@FW
conf t
 zone-pair security INSIDE-OUTSIDE source INSIDE destination OUTSIDE
  service-policy type inspect INSIDE-OUTSIDE-POLICY
 zone-pair security OUTSIDE-INSIDE source OUTSIDE destination INSIDE
  service-policy type inspect OUTSIDE-INSIDE-POLICY
  end
~~~

<br>
<br>

---
&nbsp;

## Reverse Proxy/Port Forwarding
`www.fbi.gov` vs `www.cia.gov`

<br>

~~~
!@UTM-JP
conf t
 ip access-list extended NAT 
  25 deny ip 208.8.8.0 0.0.0.255 208.8.8.0 0.0.0.255
  exit
 ip nat inside source static tcp 21.21.21.211 80 208.8.8.12 8080
 end
show ip nat trans
~~~

<br>

Access the Web: http://208.8.8.12:8080

<br>

### Exercise: Set Portforwarding Rules for:
- 208.8.8.12 8443 > 22.22.22.221 443
- 208.8.8.12 2222 > 21.21.21.211 22


Well-Known Ports    Registered Ports     Dynamic/Ephemeral Ports
	0-1023            1024-49151            49152-65535

<br>
<br>

---
&nbsp;

## Honeypot

~~~
!@cmd
nmap -v www.dpwh.gov.ph
~~~

### 1. Create a python file for the honeypot operation.
~~~
!@NetOps
sudo nano /usr/local/bin/tcp-6969-honeypot.py
~~~

<br>

Then paste the following contents to the nano shell.

<br>

~~~
#!/usr/bin/env python3
import asyncio
import datetime
import os
import argparse
import binascii
import pathlib

### LOG FILE LOCATION
BASE_LOG = '/var/log/tcp-6969-honeypot'
os.makedirs(BASE_LOG, exist_ok=True)


### CONVERT RAW BYTES TO HUMAN READABLE DATA
def hexdump(data: bytes) -> str:

  ### CONVERT RAW BYTES TO HEX STRINGS
  hexs = binascii.hexlify(data).decode('ascii')
  
  ### LOOP 32 CHAR CHUNKS TO BE A HUMAN READABLE DATA
  lines = []
  for i in range(0, len(hexs), 32):
    chunk = hexs[i:i+32]
    b = bytes.fromhex(chunk)
    printable = ''.join((chr(x) if 32 <= x < 127 else '.') for x in b)
    lines.append(f'{i//2:08x} {chunk} {printable}')
  return '\n'.join(lines)


### LOG INFORMATION ABOUT THE ATTACKER
async def handle(reader: asyncio.StreamReader, writer: asyncio.StreamWriter):
  
  ### IDENTIFY ATTACKER IP
  peer = writer.get_extra_info('peername')
  if peer is None:
    peer = ('unknown', 0)
  ip, port = peer[0], peer[1]
  
  
  ### SESSION LOGS - Year-Month-Day Hour-Minutes-Seconds
  start = datetime.datetime.utcnow().strftime("%Y%m%dT%H%M%SZ")
  sess_name = f"{start}_{ip.replace(':','_')}_{port}"
  sess_dir = pathlib.Path(BASE_LOG) / sess_name
  sess_dir.mkdir(parents=True, exist_ok=True)
  meta_file = sess_dir / "meta.txt"
  
  ### WRITE SESSION LOGS
  with meta_file.open("w") as mf:
    mf.write(f"start: {start}\npeer: {ip}:{port}\n")
  print(f"[+] connection from {ip}:{port} -> {sess_dir}")


  ### SEND MESSAGE TO THE ATTACKER
  try:
    writer.write(b'Welcome to Rivan, you Hacker!!! \r\n')
    await writer.drain()
  except Exception:
    pass


  ### DUMP RAW AND HEX DATA
  raw_file = sess_dir / "raw.bin"
  hexd_file = sess_dir / "hexdump.txt"
  try:
    with raw_file.open("ab") as rb, hexd_file.open("a") as hf:
      while True:
        data = await asyncio.wait_for(reader.read(4096), timeout=300.0)
        if not data:
          break
        ts = datetime.datetime.utcnow().isoformat() + "Z"
        rb.write(data)
        hf.write(f"\n-- {ts} --\n")
        hf.write(hexdump(data) + "\n")
        
        ### RECORD READABLE COPY
        printable = ''.join((chr(x) if 32 <= x < 127 else '.') for x in data)
        with (sess_dir / "printable.log").open("a") as pf:
          pf.write(f"{ts} {printable}\n")
        
        ### SEND TARPITTED RESPONSE
        try:
          writer.write(b"OK\r\n")
          await writer.drain()
        except Exception:
          break
  except asyncio.TimeoutError:
    print(f"[-] connection timed out {ip}:{port}")
  except Exception as e:
    print(f"[-] session error {e}")
  finally:
    try:
      writer.close()
      await writer.wait_closed()
    except Exception:
      pass
    end = datetime.datetime.utcnow().strftime("%Y%m%dT%H%M%SZ")
    with meta_file.open("a") as mf:
      mf.write(f"end: {end}\n")
    print(f"[+] closed {ip}:{port} -> {sess_dir}")


### TCP HANDLER
async def main(host, port):
  server = await asyncio.start_server(handle, host, port)
  addrs = ", ".join(str(sock.getsockname()) for sock in server.sockets)
  print(f"Listening on {addrs}")
  async with server:
    await server.serve_forever()
      
### CLI ENTRYPOINT
if __name__ == "__main__":
  parser = argparse.ArgumentParser()
  parser.add_argument("--host", default="0.0.0.0")
  parser.add_argument("--port", type=int, default=6969)
  args = parser.parse_args()
  try:
    asyncio.run(main(args.host, args.port))
  except KeyboardInterrupt:
    pass
~~~

<br>

> [!NOTE]
> Imports
> - asyncio: event loop + async IO (handles many connections efficiently).
> - datetime: timestamps.
> - os, pathlib: filesystem operations.
> - argparse: parse CLI arguments (--host, --port).
> - binascii: binary â‡„ hex conversion.

&nbsp;
---
&nbsp;

### 2. Create the directory for the log files.
~~~
!@NetOps
sudo mkdir /var/log/tcp-6969-honeypot
~~~

<br>

Make the file excecutable

<br>

~~~
!@NetOps
sudo chmod +x /usr/local/bin/tcp-6969-honeypot.py
~~~

&nbsp;
---
&nbsp;

### 3. Prevent the honeypot server from being compronised by assigning a nologin account to it.
~~~
!@NetOps
sudo useradd -r -s /sbin/nologin honeypot69 || true
sudo chown -R honeypot69:honeypot69 /var/log/tcp-6969-honeypot
~~~

&nbsp;
---
&nbsp;

### 4. Create a Systemd Service unit file
~~~
!@NetOps
nano /etc/systemd/system/tcp-6969-honeypot.service
~~~

<br>

Then paste the following

<br>

~~~
[Unit]
Description=A TCP Honeypot for port 6969
After=network.target

[Service]
User=honeypot69
Group=honeypot69
ExecStart=/usr/local/bin/tcp-6969-honeypot.py --host 0.0.0.0 --port 6969
Restart=on-failure
RestartSec=5
TimeoutStopSec=10
ProtectSystem=full
ProtectHome=yes
NoNewPrivileges=yes
PrivateTmp=yes
PrivateNetwork=no
ReadOnlyPaths=/usr
AmbientCapabilities=
SystemCallFilter=~@clock @cpu-emulation

[Install]
WantedBy=multi-user.target
~~~

&nbsp;
---
&nbsp;

### 5. Then start the service
~~~
!@NetOps
sudo systemctl daemon-reload
sudo systemctl start tcp-6969-honeypot.service
sudo systemctl status tcp-6969-honeypot.service --no-pager
~~~

<br>

### 6. OPTIONAL
If binding to ports below 1024 use the following systemd setup
~~~
NoNewPrivileges=No
AmbientCapabilities=CAP_NET_BIND_SERVICE
~~~

<br>

Exercise: Set a port forwarding rule for the honeypot and modify the firewall to allow any access to the honeypot port.

<br>
<br>

---
&nbsp;

## Secure Authentication Methods & Privilege Access Management Solutions

Generate SSH Keys:

CISCO:
~~~
!@UTM-PH
conf t
 ip domain name sec.plus
 !
 crypto key generate rsa modulus 2048 label key exportable
 ip ssh version 2
 ip ssh rsa keypair-name key
 end
show ip ssh
~~~

<br>

LINUX:
~~~
!@NetOps-PH
ssh-keygen -t rsa -b 1024 -f rsa.key
fold -w 46 rsa.key.pub
~~~

<br>

RSA vs ECDSA vs ED25519

RSA (Rivest Shamir Adleman)
  Algo: Integer factorization
  Key Size: 2048-4096 bits
  
ECDSA (Elliptical Curve Digital Signature)
  Algo: Elliptic-curve (NIST P-256/384/521)
  Key Size: 256, 384, 521 bits

ED25519 (Edwards Curve over the 2^255-19 prime field)
  Algo: Elliptic-curve (Curve25519)
  Key-Size: 256 bits

<br>

### ECDSA Key Pair
LINUX:
~~~
!@NetOps-PH
ssh-keygen -t ecdsa -b 521 -f ec.key
fold -w 46 ec.key.pub
~~~

<br>

CISCO:
~~~
!@UTM-PH
conf t
 crypto key generate ec keysize 256 label key exportable
 end
~~~

### ED25519 Key Pair
LINUX:
~~~
!@NetOps-PH
ssh-keygen -t ed25519 -a 256 -f ed.key
fold -w 46 ed.key.pub
~~~

<br>

CISCO:
~~~
!@UTM-PH
conf t
 crypto key generate ed25519 keysize 256 label key exportable
 end
~~~

<br>

Exercise: Create accounts on both Cisco and Linux servers then attach the public key to accounts.
~~~
!@UTM-PH
conf t
 username admin priv 15 secret pass
 username rivanph priv 15 secret pass
 username ______  priv 15 secret pass
 end
~~~

<br>

~~~
!@NetOps-PH
adduser rivanph
passwd rivanph
~~~

<br>

CISCO:
~~~
!@UTM-PH
conf t
 ip ssh pubkey-chain
  username rivanph
   key-string
    <PASTE PUB KEY>
	exit
   end
~~~

<br>

Disable Password authentication.
~~~
!@UTM-PH
conf t
 ip ssh server algorithm authentication publickey
 no ip ssh server algorithm authentication password
 no ip ssh server algorithm authentication keyboard
 end
~~~

<br>

LINUX:
~~~
!@NetOps-PH
nano /etc/ssh/ssh_config.d
cat key.pub >> /.ssh/authorized_keys

Paste Public Keys
~~~





















**********************
AAA

CSR1KV
- NET 2 = Bridged Replicate

~~~
!@UTM
conf t
 int g1
  ip add 208.8.8.11 255.255.255.0
  no shut
 int g2
  no shut
  ip add 10.#$34t#.1.11 255.255.255.0
 int g3
  no shut
  ip add 11.11.11.100 255.255.255.224
  exit
 ip route 0.0.0.0 0.0.0.0 208.8.8.2
 ip route 10.0.0.0 255.0.0.0 10.#$34t#.1.4
 ip route 200.0.0.0 255.255.255.0 10.#$34t#.1.4
 ip name-server 8.8.8.8 1.1.1.1
 ip domain lookup
 !
 no int tunnel 1
 no ip route 21.21.21.208 255.255.255.240
 no ip route 22.22.22.192 255.255.255.192
 end
~~~


SETUP RADIUS

~~~
!@UTM
conf t
 username admin privilege 15 secret pass
 aaa new-model
 radius server WINRAD
  address ipv4 10.12.1.8 auth-port 1812 acct-port 1813
  key C1sc0123
  exit
 aaa group server radius RADGROUP
  server name WINRAD
  exit
 aaa authentication login default group RADGROUP local
 aaa authorization exec default group RADGROUP local
 line vty 0 14
  login authentication default
 end
~~~




REMOVE AAA
~~~
!@Cisco
conf t
 no aaa new-model
 
~~~



**********
Enable Remote Server Features

SSH
Optional Features: OpenSSH

!@Powershell
start-service sshd

*************



!@PH
sudo su
ifconfig eth0 10.#$34T#.1.100 netmask 255.255.255.0 up
route add default gw 10.#$34T#.1.11
ping 10.#$34T#.1.11


!@JP
sudo su
ifconfig eth0 208.8.8.200 netmask 255.255.255.0 up
route add default gw 208.8.8.11
ping 208.8.8.11



!@IAM-LDAP
route add 0.0.0.0 mask 0.0.0.0 10.#$34T#.1.11


